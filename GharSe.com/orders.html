<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - GharSe</title>
    <link rel="icon" href="Gharse.png" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <img src="logo.png" alt="GharSe" class="logo">
                <span class="brand-text">GharSe</span>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </nav>
    </header>

    <main class="orders-main">
        <div class="container">
            <div class="orders-header">
                <h1>My Orders</h1>
                <p>Track your current orders and view order history</p>
            </div>

            <!-- Order Filters -->
            <div class="order-filters">
                <button class="filter-btn active" data-filter="all" onclick="filterOrders('all')">
                    All Orders
                </button>
                <button class="filter-btn" data-filter="active" onclick="filterOrders('active')">
                    Active Orders
                </button>
                <button class="filter-btn" data-filter="delivered" onclick="filterOrders('delivered')">
                    Past Orders
                </button>
            </div>

            <!-- Orders List -->
            <div class="orders-list" id="ordersList">
                <!-- Orders will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Order Details Modal -->
    <div class="modal-overlay hidden" id="orderDetailsModal">
        <div class="modal large-modal">
            <div class="modal-header">
                <h2>Order Details</h2>
                <button class="modal-close" onclick="closeOrderDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="orderDetailsContent">
                    <!-- Order details will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Track Order Modal -->
    <div class="modal-overlay hidden" id="trackOrderModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Track Order</h2>
                <button class="modal-close" onclick="closeTrackOrderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="trackingContent">
                    <!-- Tracking information will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Rate Order Modal -->
    <div class="modal-overlay hidden" id="rateOrderModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Rate Your Order</h2>
                <button class="modal-close" onclick="closeRateOrderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="ratingForm">
                    <div class="form-group">
                        <label>Overall Rating</label>
                        <div class="star-rating" id="orderStarRating">
                            <span class="star" data-rating="1">⭐</span>
                            <span class="star" data-rating="2">⭐</span>
                            <span class="star" data-rating="3">⭐</span>
                            <span class="star" data-rating="4">⭐</span>
                            <span class="star" data-rating="5">⭐</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="orderReview">Your Review</label>
                        <textarea id="orderReview" name="review" class="input-field" rows="4" placeholder="How was your experience?"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Submit Rating</button>
                </form>
            </div>
        </div>
    </div>

    <style>
        .orders-main {
            padding-top: 100px;
            min-height: 100vh;
            background: var(--background-warm);
        }

        .orders-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .orders-header h1 {
            font-size: 2.5rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .order-filters {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--border-light);
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .orders-list {
            max-width: 800px;
            margin: 0 auto;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .order-info h3 {
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .order-meta {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-status.placed {
            background: #fff3cd;
            color: #856404;
        }

        .order-status.confirmed {
            background: #cce5ff;
            color: #004085;
        }

        .order-status.preparing {
            background: #ffeaa7;
            color: #636e72;
        }

        .order-status.on-way {
            background: #a8e6cf;
            color: #00b894;
        }

        .order-status.delivered {
            background: #d4edda;
            color: #155724;
        }

        .order-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .order-items {
            margin-bottom: 1.5rem;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-image {
            font-size: 1.5rem;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .item-kitchen {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .item-quantity {
            background: var(--background-warm);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .order-total {
            text-align: right;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .order-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .order-actions .btn {
            flex: 1;
            min-width: 120px;
        }

        .large-modal {
            width: 90%;
            max-width: 600px;
        }

        .order-detail-section {
            margin-bottom: 2rem;
        }

        .order-detail-section h3 {
            color: var(--text-dark);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-dark);
        }

        .detail-value {
            color: var(--text-light);
        }

        .tracking-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .tracking-timeline::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-light);
        }

        .tracking-step {
            position: relative;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }

        .tracking-step::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 1.25rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border-light);
        }

        .tracking-step.completed::before {
            background: var(--success-color);
        }

        .tracking-step.active::before {
            background: var(--primary-color);
            animation: pulse 2s infinite;
        }

        .tracking-step-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .tracking-step-time {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .empty-orders {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-orders h3 {
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .empty-orders-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .order-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .order-actions {
                flex-direction: column;
            }
            
            .order-actions .btn {
                flex: none;
            }
        }
    </style>

    <script src="script.js"></script>
    <script>
        let currentFilter = 'all';
        let selectedOrderForRating = null;
        let selectedRating = 0;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!app.isAuthenticated) {
                window.location.href = 'auth.html';
                return;
            }

            initializeOrdersPage();
            setupStarRating();
        });

        function initializeOrdersPage() {
            loadOrders();
        }

        function loadOrders() {
            const userOrders = app.orders
                .filter(order => order.userId === app.currentUser?.id)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            displayOrders(userOrders);
        }

        function displayOrders(orders) {
            const ordersList = document.getElementById('ordersList');
            
            const filteredOrders = filterOrdersByStatus(orders);
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-orders">
                        <div class="empty-orders-icon">📦</div>
                        <h3>No orders found</h3>
                        <p>${getEmptyStateMessage()}</p>
                        <button class="btn btn-primary" onclick="goHome()">Start Ordering</button>
                    </div>
                `;
                return;
            }

            ordersList.innerHTML = '';
            filteredOrders.forEach(order => {
                const orderCard = createOrderCard(order);
                ordersList.appendChild(orderCard);
            });
        }

        function filterOrdersByStatus(orders) {
            if (currentFilter === 'all') return orders;
            if (currentFilter === 'active') {
                return orders.filter(order => !['delivered', 'cancelled'].includes(order.status));
            }
            if (currentFilter === 'delivered') {
                return orders.filter(order => ['delivered', 'cancelled'].includes(order.status));
            }
            return orders;
        }

        function getEmptyStateMessage() {
            if (currentFilter === 'active') return 'You have no active orders right now.';
            if (currentFilter === 'delivered') return 'You haven\'t completed any orders yet.';
            return 'You haven\'t placed any orders yet. Start exploring delicious home-cooked meals!';
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card';
            
            const orderDate = new Date(order.createdAt).toLocaleDateString();
            const orderTime = new Date(order.createdAt).toLocaleTimeString();
            
            card.innerHTML = `
                <div class="order-header">
                    <div class="order-info">
                        <h3>Order #${order.id.slice(-6).toUpperCase()}</h3>
                        <div class="order-meta">Placed on ${orderDate} at ${orderTime}</div>
                        <div class="order-meta">${order.items.length} item(s)</div>
                    </div>
                    <div class="order-status ${order.status}">${formatOrderStatus(order.status)}</div>
                </div>
                
                <div class="order-items">
                    ${order.items.slice(0, 3).map(item => {
                        const kitchen = app.kitchens.find(k => k.id === item.kitchenId);
                        return `
                            <div class="order-item">
                                <div class="item-image">${item.dish.image}</div>
                                <div class="item-details">
                                    <div class="item-name">${item.dish.name}</div>
                                    <div class="item-kitchen">${kitchen ? kitchen.name : 'Unknown Kitchen'}</div>
                                </div>
                                <div class="item-quantity">×${item.quantity}</div>
                            </div>
                        `;
                    }).join('')}
                    ${order.items.length > 3 ? `<div class="order-meta">+${order.items.length - 3} more items</div>` : ''}
                </div>
                
                <div class="order-total">Total: ₹${order.total}</div>
                
                <div class="order-actions">
                    <button class="btn btn-outline" onclick="viewOrderDetails('${order.id}')">
                        View Details
                    </button>
                    ${order.status !== 'delivered' && order.status !== 'cancelled' ? `
                        <button class="btn btn-secondary" onclick="trackOrder('${order.id}')">
                            Track Order
                        </button>
                    ` : ''}
                    ${order.status === 'delivered' ? `
                        <button class="btn btn-primary" onclick="rateOrder('${order.id}')">
                            Rate Order
                        </button>
                    ` : ''}
                    ${order.status === 'placed' || order.status === 'confirmed' ? `
                        <button class="btn btn-error" onclick="cancelOrder('${order.id}')">
                            Cancel Order
                        </button>
                    ` : ''}
                    <button class="btn btn-outline" onclick="reorder('${order.id}')">
                        Reorder
                    </button>
                </div>
            `;
            
            return card;
        }

        function formatOrderStatus(status) {
            const statuses = {
                'placed': 'Order Placed',
                'confirmed': 'Confirmed',
                'preparing': 'Preparing',
                'on-way': 'On the Way',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };
            return statuses[status] || status;
        }

        function filterOrders(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            loadOrders();
        }

        function viewOrderDetails(orderId) {
            const order = app.orders.find(o => o.id === orderId);
            if (!order) return;

            const content = document.getElementById('orderDetailsContent');
            content.innerHTML = `
                <div class="order-detail-section">
                    <h3>Order Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Order ID:</span>
                        <span class="detail-value">#${order.id.slice(-6).toUpperCase()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">${formatOrderStatus(order.status)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Order Date:</span>
                        <span class="detail-value">${new Date(order.createdAt).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Estimated Delivery:</span>
                        <span class="detail-value">${new Date(order.estimatedDelivery).toLocaleString()}</span>
                    </div>
                </div>

                <div class="order-detail-section">
                    <h3>Items Ordered</h3>
                    ${order.items.map(item => {
                        const kitchen = app.kitchens.find(k => k.id === item.kitchenId);
                        return `
                            <div class="order-item">
                                <div class="item-image">${item.dish.image}</div>
                                <div class="item-details">
                                    <div class="item-name">${item.dish.name}</div>
                                    <div class="item-kitchen">${kitchen ? kitchen.name : 'Unknown Kitchen'}</div>
                                </div>
                                <div class="item-quantity">×${item.quantity}</div>
                                <div class="item-price">₹${item.dish.price * item.quantity}</div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="order-detail-section">
                    <h3>Delivery Details</h3>
                    <div class="detail-row">
                        <span class="detail-label">Address:</span>
                        <span class="detail-value">${order.deliveryAddress || 'Not specified'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value">${order.deliveryPhone || 'Not specified'}</span>
                    </div>
                    ${order.specialInstructions ? `
                        <div class="detail-row">
                            <span class="detail-label">Special Instructions:</span>
                            <span class="detail-value">${order.specialInstructions}</span>
                        </div>
                    ` : ''}
                </div>

                <div class="order-detail-section">
                    <h3>Payment Summary</h3>
                    <div class="detail-row">
                        <span class="detail-label">Payment Method:</span>
                        <span class="detail-value">${order.paymentMethod === 'cod' ? 'Cash on Delivery' : 'Online Payment'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Amount:</span>
                        <span class="detail-value">₹${order.total}</span>
                    </div>
                </div>
            `;

            document.getElementById('orderDetailsModal').classList.remove('hidden');
        }

        function closeOrderDetailsModal() {
            document.getElementById('orderDetailsModal').classList.add('hidden');
        }

        function trackOrder(orderId) {
            const order = app.orders.find(o => o.id === orderId);
            if (!order) return;

            const trackingSteps = [
                { title: 'Order Placed', time: new Date(order.createdAt).toLocaleString(), status: 'completed' },
                { title: 'Order Confirmed', time: '', status: order.status === 'placed' ? 'pending' : 'completed' },
                { title: 'Preparing Your Food', time: '', status: ['placed', 'confirmed'].includes(order.status) ? 'pending' : order.status === 'preparing' ? 'active' : 'completed' },
                { title: 'Out for Delivery', time: '', status: ['placed', 'confirmed', 'preparing'].includes(order.status) ? 'pending' : order.status === 'on-way' ? 'active' : 'completed' },
                { title: 'Delivered', time: order.status === 'delivered' ? new Date(order.estimatedDelivery).toLocaleString() : '', status: order.status === 'delivered' ? 'completed' : 'pending' }
            ];

            const content = document.getElementById('trackingContent');
            content.innerHTML = `
                <div class="order-info" style="margin-bottom: 2rem;">
                    <h3>Order #${order.id.slice(-6).toUpperCase()}</h3>
                    <p>Estimated delivery: ${new Date(order.estimatedDelivery).toLocaleString()}</p>
                </div>
                
                <div class="tracking-timeline">
                    ${trackingSteps.map(step => `
                        <div class="tracking-step ${step.status}">
                            <div class="tracking-step-title">${step.title}</div>
                            ${step.time ? `<div class="tracking-step-time">${step.time}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('trackOrderModal').classList.remove('hidden');
        }

        function closeTrackOrderModal() {
            document.getElementById('trackOrderModal').classList.add('hidden');
        }

        function rateOrder(orderId) {
            selectedOrderForRating = orderId;
            selectedRating = 0;
            updateStarDisplay();
            document.getElementById('rateOrderModal').classList.remove('hidden');
        }

        function closeRateOrderModal() {
            document.getElementById('rateOrderModal').classList.add('hidden');
            document.getElementById('ratingForm').reset();
            selectedRating = 0;
            selectedOrderForRating = null;
        }

        function setupStarRating() {
            const stars = document.querySelectorAll('#orderStarRating .star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStarDisplay();
                });

                star.addEventListener('mouseover', function() {
                    const hoverRating = parseInt(this.dataset.rating);
                    highlightStars(hoverRating);
                });
            });

            document.getElementById('orderStarRating').addEventListener('mouseleave', function() {
                updateStarDisplay();
            });
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('#orderStarRating .star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function updateStarDisplay() {
            highlightStars(selectedRating);
        }

        function cancelOrder(orderId) {
            if (confirm('Are you sure you want to cancel this order?')) {
                const order = app.orders.find(o => o.id === orderId);
                if (order) {
                    order.status = 'cancelled';
                    app.saveToStorage();
                    loadOrders();
                    showMessage('Order cancelled successfully', 'success');
                }
            }
        }

        function reorder(orderId) {
            const order = app.orders.find(o => o.id === orderId);
            if (!order) return;

            // Clear current cart
            app.clearCart();
            
            // Add items from this order to cart
            order.items.forEach(item => {
                app.addToCart(item.kitchenId, item.dish);
                // Add additional quantities if more than 1
                for (let i = 1; i < item.quantity; i++) {
                    app.addToCart(item.kitchenId, item.dish);
                }
            });

            showMessage('Items added to cart!', 'success');
            
            // Redirect to checkout or cart
            setTimeout(() => {
                window.location.href = 'checkout.html';
            }, 1000);
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // Handle rating form submission
        document.getElementById('ratingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (selectedRating === 0) {
                showMessage('Please select a rating', 'error');
                return;
            }

            const reviewText = document.getElementById('orderReview').value;
            
            // In a real app, this would submit to a backend
            showMessage('Thank you for your rating!', 'success');
            closeRateOrderModal();
        });
    </script>
</body>
</html>
